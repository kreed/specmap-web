<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />
<title>FCC Spectrum Map</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='//api.tiles.mapbox.com/mapbox-gl-js/v0.12.1/mapbox-gl.js'></script>
<link href='//api.tiles.mapbox.com/mapbox-gl-js/v0.12.1/mapbox-gl.css' rel='stylesheet' />
<style>
body { margin:0; padding:0; }
#map { position:absolute; top:0; bottom:0; width:100%; }
#bandselect {
	position: absolute;
	top: 0;
	right: 0;
	bottom: 0;
	width: 300px;
	background: rgba(255, 255, 255, 0.8);
}
.separated-table { border-collapse: collapse; }
#bandselect thead { font-weight: bold }
#bandselect tbody { cursor: pointer }
#bandselect tr.active { background: #ddd }
.end:not(:last-child) {
	border-bottom: 1px solid black;
}
</style>
</head>
<body>
<div id='map'></div>
<table id='bandselect' class="separated-table">
	<thead>
	<tr><td>LTE Band #</td><td>Band Name</td><td>Block</td><td>Freq</td></tr>
	</thead>
	<tbody>
	<tr id='700LA'><td>12</td><td>700 Mhz (L)</td><td>A</td><td>698-704<br>728-734</td></tr>
	<tr id='700LB'><td>12,17</td><td>700 Mhz (L)</td><td>B</td><td>704-710<br>734-740</td></tr>
	<tr id='700LC'><td>12,17</td><td>700 Mhz (L)</td><td>C</td><td>710-716<br>740-746</td></tr>
	<tr id='700UC' class='end'><td>13</td><td>700 Mhz (U)</td><td>C</td><td>746-757<br>776-787</td></tr>
	<tr id='AWS1A'><td>4,66</td><td>AWS1</td><td>A</td><td>1710-1720<br>2110-2120</td></tr>
	<tr id='AWS1B'><td>4,66</td><td>AWS1</td><td>B</td><td>1720-1730<br>2120-2130</td></tr>
	<tr id='AWS1C'><td>4,66</td><td>AWS1</td><td>C</td><td>1730-1735<br>2130-2135</td></tr>
	<tr id='AWS1D'><td>4,66</td><td>AWS1</td><td>D</td><td>1735-1740<br>2135-2140</td></tr>
	<tr id='AWS1E'><td>4,66</td><td>AWS1</td><td>E</td><td>1740-1745<br>2140-2145</td></tr>
	<tr id='AWS1F'><td>4,66</td><td>AWS1</td><td>F</td><td>1745-1755<br>2145-2155</td></tr>
	<tr id='AWS3G'><td>66</td><td>AWS3</td><td>G</td><td>1755-1760<br>2155-2160</td></tr>
	<tr id='AWS3H'><td>66</td><td>AWS3</td><td>H</td><td>1760-1765<br>2160-2165</td></tr>
	<tr id='AWS3I'><td>66</td><td>AWS3</td><td>I</td><td>1765-1770<br>2165-2170</td></tr>
	<tr id='AWS3J' class='end'><td>66</td><td>AWS3</td><td>J</td><td>1770-1780<br>2170-2180</td></tr>
	<tr id='PCSA'><td>2,25</td><td>PCS</td><td>A</td><td>1850-1865<br>1930-1945</td></tr>
	<tr id='PCSD'><td>2,25</td><td>PCS</td><td>D</td><td>1865-1870<br>1945-1950</td></tr>
	<tr id='PCSB'><td>2,25</td><td>PCS</td><td>B</td><td>1870-1885<br>1950-1965</td></tr>
	<tr id='PCSE'><td>2,25</td><td>PCS</td><td>E</td><td>1885-1890<br>1965-1970</td></tr>
	<tr id='PCSF'><td>2,25</td><td>PCS</td><td>F</td><td>1890-1895<br>1970-1975</td></tr>
	<tr id='PCSC'><td>2,25</td><td>PCS</td><td>C</td><td>1895-1910<br>1975-1990</td></tr>
	<tr id='PCSG' class='end'><td>25</td><td>PCS</td><td>G</td><td>1910-1915<br>1990-1995</td></tr>
	<tr id='WCSA'><td>30</td><td>WCS</td><td>A</td><td>2305-2310<br>2350-2355</td></tr>
	<tr id='WCSB'><td>30</td><td>WCS</td><td>B</td><td>2310-2315<br>2355-2360</td></tr>
	</tbody>
</table>
<script>
mapboxgl.accessToken = 'pk.eyJ1Ijoia3JlM2QiLCJhIjoieU9KWThOUSJ9.lMOWQzER-r4HQZwX8vIWbw';

var map = new mapboxgl.Map({
	container: "map",
	style: 'mapbox://styles/kre3d/cij66zhmy00599hkl0drs773s',
	center: [-98.580, 39.828],
	zoom: 4
});

color_table = {
	'T-Mobile': '#ff00ff',
	'iWireless': '#ff9cff',
	'C Spire': '#208dd9',
	'AT&T': '#00FFFF',
	'US Cellular': '#A5CCE8',
	'AB License Co': '#00ff00',
	'Cavalier': '#009E60',
	'Continuum 700': '#BFFF00',
	"Sprint": '#FFFF00',
	"Verizon": '#ff0000',
	'Dish Network': '#ff7794',
	'Infrastructure Networks': '#000000',
};

function swapBandLayers(band) {
	var proto = {
		"interactive": true,
		"type": "fill",
		"source": "specmap",
		"source-layer": "specmap",
		"filter": ["all", ["==", "block", band]],
		"paint": {
			"fill-opacity": 0.5,
			"fill-color": "#555",
			"fill-outline-color": "#000",
		}
	}

	var rows = document.querySelectorAll('#bandselect tbody tr');
	for (var i = 0; i < rows.length; ++i) {
		if (rows[i].id == band) {
			rows[i].classList.add('active');
		} else {
			rows[i].classList.remove('active');
		}
	}

	map.batch(function(batch) {
		for (var l in map.style._layers) {
			if (l.indexOf('specmap') >= 0) {
				batch.removeLayer(l);
			}
		}

		batch.addLayer({
			"id": "hidden_specmap",
			"interactive": true,
			"type": "fill",
			"source": "specmap",
			"source-layer": "specmap",
			"filter": ["!=", "block", band],
			"paint": {
				"fill-opacity": 0,
			}
		});

		var l = Object.assign({ "id": "specmap_default" }, proto);
		l.filter = l.filter.concat([["!in", "owner_dba"].concat(Object.keys(color_table))]);
		batch.addLayer(l);

		for (var owner in color_table) {
			var l = Object.assign({ "id": "specmap_" + owner }, proto);
			l.filter = l.filter.concat([["==", "owner_dba", owner]]);
			l.paint['fill-color'] = color_table[owner];
			batch.addLayer(l);
		}
	});
}

map.on('style.load', function () {
	map.addSource('specmap', {
		type: 'vector',
		tiles: [(location.protocol == 'https:' ? 'https' : 'http') + "://kreed.org/specmap/tiles/{z}/{x}/{y}.pbf"],
		minzoom: 0,
		maxzoom: 10,
		attribution: '<a href="specmap.mbtiles">Download data</a>'
	});

	swapBandLayers('700LA');

	var rows = document.querySelectorAll('#bandselect tbody tr');
	for (var i = 0; i < rows.length; ++i) {
		rows[i].addEventListener('click', function(e) {
			swapBandLayers(this.id);
		});
	}
});

map.on('click', function (e) {
	map.featuresAt(e.point, {}, function (err, features) {
		if (err) throw err;
		var html = '';
		var bws = {}
		for (var i = 0; i < features.length; ++i) {
			var p = features[i]['properties'];

			if (features[i]['layer']['id'].startsWith('specmap')) {
				html += '<tr><td>Owner</td><td>' + (p.owner_dba ? p.owner_dba : p.owner) + '</td></tr>';
				html += '<tr><td>Market Area</td><td>' + p.market + '</td></tr>';
				html += '<tr><td>Call Sign</td><td><a href="http://wireless2.fcc.gov/UlsApp/UlsSearch/license.jsp?licKey=' + p.uls_number + '">' + p.call_sign + '</a></td></tr>';
				html += '<tr><td>Population</td><td>' + p.population + '</td></tr>';
				html += '<tr><td>Frequency (downlink)</td><td>' + p.downlink + '</td></tr>';
				html += '<tr class="end"><td>Frequency (uplink)</td><td>' + p.uplink + '</td></tr>';
			}

			if (p.downlink) {
				var ranges = p.downlink.split(',');
				for (var j = 0; j < ranges.length; ++j) {
					var pair = ranges[j].split('-');
					var bw = parseFloat(pair[1]) - parseFloat(pair[0]);
					var owner = p.owner_dba ? p.owner_dba : p.owner;
					if (!bws[owner]) bws[owner] = 0;
					bws[owner] += bw;
				}
			}
		}
		for (var owner in bws) {
			html += '<tr><td>' + owner + '</td><td>' + bws[owner] + '</td></tr>';
		}
		if (html) {
			var tooltip = new mapboxgl.Popup()
				.setLngLat(e.lngLat)
				.setHTML('<table class="separated-table">' + html + '</table>')
				.addTo(map);
		}
	});
});

//map.addControl(new mapboxgl.Navigation());
</script>
</body>
</html>
